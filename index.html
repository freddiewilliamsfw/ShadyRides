<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Bus Shade Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        select, button { margin: 10px 0; padding: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>London Bus Shade Calculator</h1>
    <select id="routeSelect">
        <option value="">Select a route</option>
    </select>
    <br>
    <select id="runSelect" style="display: none;">
        <option value="">Select a run</option>
    </select>
    <br>
    <select id="startStop" style="display: none;">
        <option value="">Select start stop</option>
    </select>
    <br>
    <select id="endStop" style="display: none;">
        <option value="">Select end stop</option>
    </select>
    <br>
    <button onclick="calculateShade()" style="display: none;">Calculate Shade Side</button>
    <p id="result"></p>
    <p id="direction"></p>
    <script>
        let busRoutes = {};
        fetch('bus_routes.csv')
            .then(response => response.text())
            .then(data => {
                const rows = data.split('\n').slice(1);
                rows.forEach(row => {
                    const [route, run, sequence, , , , stopName, easting, northing] = row.split(',');
                    if (!busRoutes[route]) {
                        busRoutes[route] = {};
                    }
                    if (!busRoutes[route][run]) {
                        busRoutes[route][run] = [];
                    }
                    busRoutes[route][run].push({ 
                        name: stopName, 
                        easting: parseInt(easting), 
                        northing: parseInt(northing),
                        sequence: parseInt(sequence)
                    });
                });
                for (let route in busRoutes) {
                    for (let run in busRoutes[route]) {
                        busRoutes[route][run].sort((a, b) => a.sequence - b.sequence);
                    }
                }
                populateRouteSelect();
            });

        function populateRouteSelect() {
            const select = document.getElementById('routeSelect');
            Object.keys(busRoutes).forEach(route => {
                const option = document.createElement('option');
                option.value = route;
                option.textContent = route;
                select.appendChild(option);
            });
        }

        document.getElementById('routeSelect').addEventListener('change', function() {
            const runSelect = document.getElementById('runSelect');
            runSelect.innerHTML = '<option value="">Select a run</option>';
            runSelect.style.display = 'block';
            
            const route = busRoutes[this.value];
            Object.keys(route).forEach(run => {
                const option = document.createElement('option');
                option.value = run;
                option.textContent = `Run ${run}`;
                runSelect.appendChild(option);
            });

            document.getElementById('startStop').style.display = 'none';
            document.getElementById('endStop').style.display = 'none';
            document.querySelector('button').style.display = 'none';
        });

        document.getElementById('runSelect').addEventListener('change', function() {
            const route = document.getElementById('routeSelect').value;
            const run = this.value;
            const stops = busRoutes[route][run] || [];

            const startSelect = document.getElementById('startStop');
            const endSelect = document.getElementById('endStop');
            startSelect.innerHTML = '<option value="">Select start stop</option>';
            endSelect.innerHTML = '<option value="">Select end stop</option>';

            stops.forEach((stop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${stop.sequence}. ${stop.name}`;
                startSelect.appendChild(option.cloneNode(true));
                endSelect.appendChild(option);
            });

            startSelect.style.display = 'block';
            endSelect.style.display = 'block';
            document.querySelector('button').style.display = 'block';
        });

        function calculateBearing(startEasting, startNorthing, endEasting, endNorthing) {
            const y = endEasting - startEasting;
            const x = endNorthing - startNorthing;
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            if (bearing < 0) {
                bearing += 360;
            }
            return bearing;
        }

        function getCompassDirection(bearing) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return directions[Math.round(bearing / 45) % 8];
        }

        function getShadySide(bearing) {
            if (bearing === 0 || bearing === 180 || bearing === 360) {
                return "It doesn't matter which side you sit!";
            } else if (bearing > 0 && bearing < 180) {
                return "left";
            } else {
                return "right";
            }
        }

        function calculateShade() {
            const route = document.getElementById('routeSelect').value;
            const run = document.getElementById('runSelect').value;
            const startIndex = document.getElementById('startStop').value;
            const endIndex = document.getElementById('endStop').value;

            if (!route || !run || startIndex === '' || endIndex === '') {
                alert('Please select a route, run, and both stops.');
                return;
            }

            const startStop = busRoutes[route][run][startIndex];
            const endStop = busRoutes[route][run][endIndex];

            const bearing = calculateBearing(startStop.easting, startStop.northing, endStop.easting, endStop.northing);
            const compassDirection = getCompassDirection(bearing);
            const shadySide = getShadySide(bearing);

            const resultText = shadySide === "It doesn't matter which side you sit!" 
                ? shadySide 
                : `For the most shade, sit on the ${shadySide} side of the bus.`;

            document.getElementById('result').textContent = resultText;
            document.getElementById('direction').textContent = `The bus is traveling in a ${compassDirection} direction (bearing: ${bearing.toFixed(2)}Â°).`;
        }
    </script>
</body>
</html>
