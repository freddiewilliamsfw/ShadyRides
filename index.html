<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shady Rides</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        .logo-container {
            width: 30%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .logo {
            max-width: 100%;
            height: auto;
        }
        .content {
            width: 70%;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            color: #333;
        }
        select, button {
            margin: 10px 0;
            padding: 5px;
            width: 200px;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="srlogo.png" alt="Shady Rides Logo" class="logo">
    </div>
    <div class="content">
        <h1>Shady Rides</h1>
        <select id="routeSelect">
            <option value="">Select a route</option>
        </select>
        <br>
        <select id="runSelect" style="display: none;">
            <option value="">Select a run</option>
        </select>
        <br>
        <select id="startStop" style="display: none;">
            <option value="">Select start stop</option>
        </select>
        <br>
        <select id="endStop" style="display: none;">
            <option value="">Select end stop</option>
        </select>
        <br>
        <button onclick="calculateShade()" style="display: none;">Calculate Shade Side</button>
        <p id="result"></p>
        <p id="direction"></p>
        <div id="map"></div>
    </div>
    <script>
        let busRoutes = {};
        let map;
        let routeLayer;

        function initMap() {
            map = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        function calculateBearing(startEasting, startNorthing, endEasting, endNorthing) {
            const y = endEasting - startEasting;
            const x = endNorthing - startNorthing;
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            if (bearing < 0) {
                bearing += 360;
            }
            return bearing;
        }

        function getRunDirection(bearing) {
            if ((bearing >= 0 && bearing < 45) || (bearing >= 315 && bearing <= 360)) {
                return 'Northbound';
            } else if (bearing >= 45 && bearing < 135) {
                return 'Eastbound';
            } else if (bearing >= 135 && bearing < 225) {
                return 'Southbound';
            } else {
                return 'Westbound';
            }
        }

        function convertToLatLon(easting, northing) {
            // This is a simplified conversion and may not be accurate for all of UK
            // For a more accurate conversion, consider using a library like proj4js
            const E = easting;
            const N = northing;
            const a = 6377563.396;
            const b = 6356256.909;
            const F0 = 0.9996012717;
            const lat0 = 49 * Math.PI / 180;
            const lon0 = -2 * Math.PI / 180;
            const N0 = -100000;
            const E0 = 400000;
            const e2 = 1 - (b * b) / (a * a);
            const n = (a - b) / (a + b);

            const lat = lat0;
            const M = (N - N0) / F0 + lat0;

            let lat1 = M / (a * F0);
            let lat2;
            do {
                lat2 = lat1;
                const M1 = (1 + n + (5 / 4) * Math.pow(n, 2) + (5 / 4) * Math.pow(n, 3)) * (lat2 - lat0);
                const M2 = (3 * n + 3 * Math.pow(n, 2) + (21 / 8) * Math.pow(n, 3)) * Math.sin(lat2 - lat0) * Math.cos(lat2 + lat0);
                const M3 = ((15 / 8) * Math.pow(n, 2) + (15 / 8) * Math.pow(n, 3)) * Math.sin(2 * (lat2 - lat0)) * Math.cos(2 * (lat2 + lat0));
                const M4 = (35 / 24) * Math.pow(n, 3) * Math.sin(3 * (lat2 - lat0)) * Math.cos(3 * (lat2 + lat0));
                lat1 = M / (a * F0) + (M1 - M2 + M3 - M4);
            } while (Math.abs(lat2 - lat1) > 1e-12);

            const cosLat = Math.cos(lat1);
            const sinLat = Math.sin(lat1);
            const nu = a * F0 / Math.sqrt(1 - e2 * sinLat * sinLat);
            const rho = a * F0 * (1 - e2) / Math.pow(1 - e2 * sinLat * sinLat, 1.5);
            const eta2 = nu / rho - 1;

            const tanLat = Math.tan(lat1);
            const tan2lat = tanLat * tanLat;
            const tan4lat = tan2lat * tan2lat;
            const tan6lat = tan4lat * tan2lat;
            const secLat = 1 / cosLat;
            const nu3 = nu * nu * nu;
            const nu5 = nu3 * nu * nu;
            const nu7 = nu5 * nu * nu;
            const VII = tanLat / (2 * rho * nu);
            const VIII = tanLat / (24 * rho * nu3) * (5 + 3 * tan2lat + eta2 - 9 * tan2lat * eta2);
            const IX = tanLat / (720 * rho * nu5) * (61 + 90 * tan2lat + 45 * tan4lat);
            const X = secLat / nu;
            const XI = secLat / (6 * nu3) * (nu / rho + 2 * tan2lat);
            const XII = secLat / (120 * nu5) * (5 + 28 * tan2lat + 24 * tan4lat);
            const XIIA = secLat / (5040 * nu7) * (61 + 662 * tan2lat + 1320 * tan4lat + 720 * tan6lat);

            const dE = (E - E0);
            const dE2 = dE * dE;
            const dE3 = dE2 * dE;
            const dE4 = dE2 * dE2;
            const dE5 = dE3 * dE2;
            const dE6 = dE4 * dE2;
            const dE7 = dE5 * dE2;
            const lat2 = lat1 - VII * dE2 + VIII * dE4 - IX * dE6;
            const lon = lon0 + X * dE - XI * dE3 + XII * dE5 - XIIA * dE7;

            return [lat2 * 180 / Math.PI, lon * 180 / Math.PI];
        }

        function plotRoute(route, run) {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            const stops = busRoutes[route][run];
            const latLngs = stops.map(stop => convertToLatLon(stop.easting, stop.northing));
            routeLayer = L.polyline(latLngs, {color: 'red'}).addTo(map);
            map.fitBounds(routeLayer.getBounds());
            
            stops.forEach((stop, index) => {
                const [lat, lon] = convertToLatLon(stop.easting, stop.northing);
                L.marker([lat, lon]).addTo(map)
                    .bindPopup(`Stop ${index + 1}: ${stop.name}`);
            });
        }

        fetch('bus_routes.csv')
            .then(response => response.text())
            .then(data => {
                const rows = data.split('\n').slice(1);
                rows.forEach(row => {
                    const [route, run, sequence, , , , stopName, easting, northing] = row.split(',');
                    if (!busRoutes[route]) {
                        busRoutes[route] = {};
                    }
                    if (!busRoutes[route][run]) {
                        busRoutes[route][run] = [];
                    }
                    busRoutes[route][run].push({ 
                        name: stopName, 
                        easting: parseInt(easting), 
                        northing: parseInt(northing),
                        sequence: parseInt(sequence)
                    });
                });
                for (let route in busRoutes) {
                    for (let run in busRoutes[route]) {
                        busRoutes[route][run].sort((a, b) => a.sequence - b.sequence);
                        const firstStop = busRoutes[route][run][0];
                        const lastStop = busRoutes[route][run][busRoutes[route][run].length - 1];
                        const bearing = calculateBearing(firstStop.easting, firstStop.northing, lastStop.easting, lastStop.northing);
                        busRoutes[route][run].direction = getRunDirection(bearing);
                    }
                }
                populateRouteSelect();
                initMap();
            });

        function populateRouteSelect() {
            const select = document.getElementById('routeSelect');
            Object.keys(busRoutes).forEach(route => {
                const option = document.createElement('option');
                option.value = route;
                option.textContent = route;
                select.appendChild(option);
            });
        }

        document.getElementById('routeSelect').addEventListener('change', function() {
            const runSelect = document.getElementById('runSelect');
            runSelect.innerHTML = '<option value="">Select a run</option>';
            runSelect.style.display = 'block';
            
            const route = busRoutes[this.value];
            Object.keys(route).forEach(run => {
                const option = document.createElement('option');
                option.value = run;
                option.textContent = `${route[run].direction} (Run ${run})`;
                runSelect.appendChild(option);
            });

            document.getElementById('startStop').style.display = 'none';
            document.getElementById('endStop').style.display = 'none';
            document.querySelector('button').style.display = 'none';
        });

        document.getElementById('runSelect').addEventListener('change', function() {
            const route = document.getElementById('routeSelect').value;
            const run = this.value;
            const stops = busRoutes[route][run] || [];

            const startSelect = document.getElementById('startStop');
            const endSelect = document.getElementById('endStop');
            startSelect.innerHTML = '<option value="">Select start stop</option>';
            endSelect.innerHTML = '<option value="">Select end stop</option>';

            stops.forEach((stop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${stop.sequence}. ${stop.name}`;
                startSelect.appendChild(option.cloneNode(true));
                endSelect.appendChild(option);
            });

            startSelect.style.display = 'block';
            endSelect.style.display = 'block';
            document.querySelector('button').style.display = 'block';

            plotRoute(route, run);
        });

        function getCompassDirection(bearing) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return directions[Math.round(bearing / 45) % 8];
        }

        function getShadySide(bearing) {
            if (bearing === 0 || bearing === 180 || bearing === 360) {
                return "It doesn't matter which side you sit!";
            } else if (bearing > 0 && bearing < 180) {
                return "left";
            } else {
                return "right";
            }
        }

        function calculateShade() {
            const route = document.getElementById('routeSelect').value;
            const run = document.getElementById('runSelect').value;
            const startIndex = document.getElementById('startStop').value;
            const endIndex = document.getElementById('endStop').value;

            if (!route || !run || startIndex === '' || endIndex === '') {
                alert('Please select a route, run, and both stops.');
                return;
            }

            const startStop = busRoutes[route][run][startIndex];
            const endStop = busRoutes[route][run][endIndex];

            const bearing = calculateBearing(startStop.easting, startStop.northing, endStop.easting, endStop.northing);
            const compassDirection = getCompassDirection(bearing);
            const shadySide = getShadySide(bearing);

            const resultText = shadySide === "It doesn't matter which side you sit!" 
                ? shadySide 
                : `For the most shade, sit on the ${shadySide} side of the bus.`;

            document.getElementById('result').textContent = resultText;
            document.getElementById('direction').textContent = `The bus is traveling in a ${compassDirection} direction (bearing: ${bearing.toFixed(2)}°).`;
        }
    </script>
</body>
</html>
