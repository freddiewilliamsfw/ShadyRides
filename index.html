<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Bus Shade Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        select, button { margin: 10px 0; padding: 5px; width: 200px; }
        #error { color: red; }
    </style>
</head>
<body>
    <h1>London Bus Shade Calculator</h1>
    <select id="routeSelect">
        <option value="">Select a route</option>
    </select>
    <br>
    <select id="startStop">
        <option value="">Select start stop</option>
    </select>
    <br>
    <select id="endStop">
        <option value="">Select end stop</option>
    </select>
    <br>
    <button onclick="calculateShade()">Calculate Shade Side</button>
    <p id="result"></p>
    <p id="error"></p>
    <script>
        let busRoutes = {};

        fetch('bus_routes.csv')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                console.log("CSV data received:", data.slice(0, 200) + "..."); // Log first 200 characters
                const rows = data.split('\n').slice(1);
                console.log(`Number of rows: ${rows.length}`);
                rows.forEach((row, index) => {
                    const [route, , sequence, , , , stopName, easting, northing] = row.split(',');
                    if (!route) {
                        console.log(`Empty route at row ${index + 2}`);
                        return;
                    }
                    if (!busRoutes[route]) {
                        busRoutes[route] = [];
                    }
                    busRoutes[route].push({ 
                        name: stopName, 
                        easting: parseInt(easting), 
                        northing: parseInt(northing),
                        sequence: parseInt(sequence)
                    });
                });
                console.log("Routes processed:", Object.keys(busRoutes));
                for (let route in busRoutes) {
                    busRoutes[route].sort((a, b) => a.sequence - b.sequence);
                }
                populateRouteSelect();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
            });

        function populateRouteSelect() {
            const select = document.getElementById('routeSelect');
            const routes = Object.keys(busRoutes);
            console.log(`Populating route select with ${routes.length} routes`);
            if (routes.length === 0) {
                document.getElementById('error').textContent = "No routes found in the data.";
                return;
            }
            routes.forEach(route => {
                const option = document.createElement('option');
                option.value = route;
                option.textContent = route;
                select.appendChild(option);
            });
            console.log("Route select populated");
        }

        document.getElementById('routeSelect').addEventListener('change', function() {
            const stops = busRoutes[this.value] || [];
            const startSelect = document.getElementById('startStop');
            const endSelect = document.getElementById('endStop');
            startSelect.innerHTML = '<option value="">Select start stop</option>';
            endSelect.innerHTML = '<option value="">Select end stop</option>';
            stops.forEach((stop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = stop.name;
                startSelect.appendChild(option.cloneNode(true));
                endSelect.appendChild(option);
            });
        });

        function calculateShade() {
            const route = document.getElementById('routeSelect').value;
            const startIndex = document.getElementById('startStop').value;
            const endIndex = document.getElementById('endStop').value;

            if (!route || startIndex === '' || endIndex === '') {
                alert('Please select a route and both stops.');
                return;
            }

            const startStop = busRoutes[route][startIndex];
            const endStop = busRoutes[route][endIndex];

            const direction = Math.atan2(endStop.northing - startStop.northing, endStop.easting - startStop.easting) * 180 / Math.PI;
            
            // Simplified sun position (always assume sun is in the south)
            const sunAzimuth = 180;
            const diff = (direction - sunAzimuth + 360) % 360;
            const shadeSide = diff >= 0 && diff < 180 ? 'left' : 'right';

            document.getElementById('result').textContent = `For the most shade, sit on the ${shadeSide} side of the bus.`;
        }
    </script>
</body>
</html>
